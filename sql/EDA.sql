select * from customer;

-- Q1. What is the total revenue generated by male vs. female customers?
select
	gender,
	SUM(purchase_amount)
from 
	customer
group by
	gender;
	
-- Q2. Which customers used a discount but still spent more than the average purchase amount? 
SELECT
	customer_id,
	purchase_amount
FROM 
	customer
WHERE 
	discount_applied = 'Yes'
	AND purchase_amount > (SELECT AVG(purchase_amount) FROM customer);

-- Q3. Which are the top 5 products with the highest average review rating?
select
	item_purchased,
	ROUND(AVG(review_rating)::numeric,2) AS average_review_rating
from
	customer
group by
	item_purchased
order by average_review_rating DESC
LIMIT 5;

-- Q4. Compare the average Purchase Amounts between Standard and Express Shipping.
select
	shipping_type,
	ROUND(AVG(purchase_amount),2) AS avg_purchase_amount
from
	customer
where
	shipping_type in ('Standard', 'Express')
group by
	shipping_type
order by
	avg_purchase_amount DESC;

-- Q5. Do subscribed customers spend more? Compare average spend and total revenue between subscribers and non-subscribers.
select
	subscription_status,
	AVG(purchase_amount) AS avg_amount_spent,
	SUM(purchase_amount) AS total_revenue
from
	customer
group by
	subscription_status;

-- Q6. Which 5 products have the highest percentage of purchases with discounts applied?
select
	item_purchased,
	ROUND(100* SUM(CASE WHEN discount_applied = 'Yes' THEN 1 ELSE 0 END)/count(*),2) AS discount_rate
from
	customer
group by
	item_purchased
order by
	discount_rate DESC
LIMIT 5;

-- Q7. Segment customers into New, Returning, and Loyal based on their total number of previous purchases, and show the count of each segment.
with customer_type AS (
	select
		customer_id,
		previous_purchases,
		CASE 
			WHEN previous_purchases = 1 THEN 'New'
			WHEN previous_purchases BETWEEN 2 AND 10 THEN 'Returning'
			ELSE 'Loyal'
		END AS customer_segment
	from
		customer
)
select
	customer_segment, count(*) as "Number of Customers"
from
	customer_type
group by customer_segment;
		
)

-- Q8. What are the top 3 most purchased products within each category? 
with item_counts AS (
	select
		category,
		item_purchased,
		count(customer_id) AS total_orders,
		ROW_NUMBER() OVER (
			partition by 
				category 
			order by 
				count(customer_id) DESC
			) as item_rank
	from
		customer
	group by category, item_purchased
)
select
	item_rank,
	category,
	item_purchased,
	total_orders
from
	item_counts
where 
	item_rank <=3;


-- Q9. Are customers who are repeat buyers (more than 5 previous purchases) also likely to subscribe?
select
	subscription_status,
	count(customer_id) AS repeat_buyers 
from
	customer
where
	previous_purchases > 5
group by
	subscription_status;

-- Q10. What is the revenue contribution of each age group? 
select
	age_group,
	SUM(purchase_amount) AS total_revenue
from
	customer
group by
	age_group
order by
	total_revenue DESC;